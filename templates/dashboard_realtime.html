<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Dashboard (Real-time)</title>
    <!-- Material Design Lite CSS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <style>
        .mdl-layout__content {
            padding: 24px;
        }
        .mdl-card {
            width: 100%;
            margin-bottom: 24px;
        }
        .mdl-card__title {
            color: #fff;
            background-color: #3f51b5;
        }
        .option-button {
            width: 100%;
            margin: 8px 0;
            text-align: left;
        }
        .response-entry {
            padding: 8px;
            margin: 4px 0;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .correct {
            color: #4CAF50;
        }
        .incorrect {
            color: #F44336;
        }
        .connection-status {
            padding: 8px;
            margin: 8px 0;
            border-radius: 4px;
            text-align: center;
        }
        .connected {
            background-color: #4CAF50;
            color: white;
        }
        .disconnected {
            background-color: #F44336;
            color: white;
        }
    </style>
</head>
<body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
        <header class="mdl-layout__header">
            <div class="mdl-layout__header-row">
                <span class="mdl-layout-title">Quiz Dashboard (Real-time)</span>
                <div class="mdl-layout-spacer"></div>
                <a href="/" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                    Home
                </a>
            </div>
        </header>
        <main class="mdl-layout__content">
            <div class="mdl-card mdl-shadow--2dp">
                <div class="mdl-card__title">
                    <h2 class="mdl-card__title-text">Question {{ index + 1 }} of {{ total }}</h2>
                </div>
                <div class="mdl-card__supporting-text">
                    <h4>{{ quiz.question }}</h4>
                    <div class="mdl-grid">
                        <div class="mdl-cell mdl-cell--6-col">
                            <button class="mdl-button mdl-js-button mdl-button--raised option-button" onclick="submitAnswer('A')">
                                A. {{ quiz.options.A }}
                            </button>
                            <button class="mdl-button mdl-js-button mdl-button--raised option-button" onclick="submitAnswer('B')">
                                B. {{ quiz.options.B }}
                            </button>
                        </div>
                        <div class="mdl-cell mdl-cell--6-col">
                            <button class="mdl-button mdl-js-button mdl-button--raised option-button" onclick="submitAnswer('C')">
                                C. {{ quiz.options.C }}
                            </button>
                            <button class="mdl-button mdl-js-button mdl-button--raised option-button" onclick="submitAnswer('D')">
                                D. {{ quiz.options.D }}
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mdl-card__actions mdl-card--border">
                    <a href="/next" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                        Next Question
                    </a>
                    <a href="/analysis" class="mdl-button mdl-js-button mdl-button--raised">
                        View Analysis
                    </a>
                </div>
            </div>

            <div class="mdl-card mdl-shadow--2dp">
                <div class="mdl-card__title">
                    <h2 class="mdl-card__title-text">Live Responses (Real-time)</h2>
                </div>
                <div class="mdl-card__supporting-text">
                    <div id="connectionStatus" class="connection-status disconnected">
                        Connecting to real-time updates...
                    </div>
                    <div id="responseContainer">
                        <!-- Responses will be added here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let eventSource;
        let isConnected = false;
        
        // Function to display responses
        function displayResponses(responses) {
            const container = document.getElementById('responseContainer');
            container.innerHTML = ''; // Clear existing responses
            
            responses.forEach(data => {
                const div = document.createElement('div');
                div.className = 'response-entry';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="${data.correct ? 'correct' : 'incorrect'}">
                            📘 ${data.student} selected option ${data.option}
                        </span>
                        <small style="color: #666;">${new Date(data.timestamp).toLocaleTimeString()}</small>
                    </div>
                    <div style="font-size: 0.9em; color: #666; margin-top: 4px;">
                        Q: ${data.question_text.substring(0, 50)}${data.question_text.length > 50 ? '...' : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Function to update connection status
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            isConnected = connected;
            if (connected) {
                statusEl.textContent = '✅ Connected to real-time updates';
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = '❌ Disconnected from real-time updates';
                statusEl.className = 'connection-status disconnected';
            }
        }
        
        // Function to start real-time connection
        function startRealtimeConnection() {
            eventSource = new EventSource('/api/live_responses_stream');
            
            eventSource.onopen = function(event) {
                console.log('Real-time connection opened');
                updateConnectionStatus(true);
            };
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.responses) {
                        displayResponses(data.responses);
                    }
                } catch (error) {
                    console.error('Error parsing SSE data:', error);
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('Real-time connection error:', event);
                updateConnectionStatus(false);
                // Attempt to reconnect after 3 seconds
                setTimeout(() => {
                    if (eventSource.readyState === EventSource.CLOSED) {
                        console.log('Attempting to reconnect...');
                        startRealtimeConnection();
                    }
                }, 3000);
            };
        }
        
        // Function to stop real-time connection
        function stopRealtimeConnection() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                updateConnectionStatus(false);
            }
        }
        
        // Start real-time connection when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startRealtimeConnection();
        });
        
        // Stop connection when page unloads
        window.addEventListener('beforeunload', function() {
            stopRealtimeConnection();
        });

        function submitAnswer(option) {
            const student = prompt('Enter your name:');
            if (student) {
                fetch(`/receive_data?student=${encodeURIComponent(student)}&option=${option}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Error: ' + data.error);
                        } else {
                            console.log('Response submitted successfully');
                            // Real-time updates will be handled by the SSE connection
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error submitting response');
                    });
            }
        }
    </script>
</body>
</html>
